name: CI/CD

on:
  push:
    branches: [main]

jobs:
  continuous-integration:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

  continuous-deployment:
    runs-on: self-hosted
    needs: [continuous-integration]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Deploy to Docker
        env:
          REPO_DIR: ~/edulink-backend
        run: |
          # Check if the directory exists, if not, create it
          if [ ! -d "$REPO_DIR" ]; then
            mkdir -p "$REPO_DIR"
          fi

          cd "$REPO_DIR"
          
          # If the directory exists, clean and update the code
          if [ -d ".git" ]; then
            git reset --hard
            git pull origin main
          else
            git clone https://github.com/Basimohd/edulink-backend.git .
          fi

          # Restart Docker services
          docker-compose down
          docker-compose up -d
